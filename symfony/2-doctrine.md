h2. 查询构建


```php

<?php

namespace Uco\OmsBundle\Entity;

use Doctrine\ORM\QueryBuilder;
use Uco\OmsBundle\Constant\Vip\PickStatus;

/**
 * VipPickOrderRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class VipPickOrderRepository extends \Doctrine\ORM\EntityRepository
{
    public function getCountByParams(array $params)
    {
        return $this->filterParams($this->createQueryBuilder('vpo'), $params)
            ->select('count(vpo.id)')
            ->getQuery()
            ->getSingleScalarResult();
    }

    public function getOrdersByParams(array $params, int $pagesize = 20)
    {
        $queryBuilder = $this->filterParams($this->createQueryBuilder('vpo'), $params);
        $queryBuilder->orderBy('vpo.created', 'DESC');
        $queryBuilder->setMaxResults($pagesize);
        if (isset($params['p']) && $params['p'] > 0)
            $queryBuilder->setFirstResult(($params['p'] - 1) * $pagesize);

        return $queryBuilder->getQuery()->getResult();
    }

    private function filterParams(QueryBuilder $queryBuilder, array $params) :QueryBuilder
    {
        $queryBuilder->andWhere('vpo.status!=:status1')->setParameter('status1', PickStatus::UNREAD);
        if( ! empty($params['storage_no'])) {
            $queryBuilder->leftJoin('vpo.vipDeliveryOrder', 'vdo');
            $queryBuilder->andWhere('vdo.storage_no=:storage_no')->setParameter('storage_no', $params['storage_no']);
        }
        if( ! empty($params['platformOrderId'])) {
            $queryBuilder->andWhere('vpo.platformOrderId=:platformId')->setParameter('platformOrderId', $params['platformOrderId']);
        }
        if(!empty($params['platformId'])) {
            $queryBuilder->andWhere('vpo.platformId=:platformId')->setParameter('platformId', $params['platformId']);
        }
        if(!empty($params['status'])) {
            $queryBuilder->andWhere('vpo.status=:status')->setParameter('status', $params['status']);
        }
        if(!empty($params['pick_no'])) {
            $queryBuilder->andWhere('vpo.pick_no=:pick_no')->setParameter('pick_no', $params['pick_no']);
        }
        if( ! empty($params['startCreated'])) {
            $queryBuilder->andWhere('vpo.created >= :startCreated')->setParameter('startCreated', $params['startCreated']);
        }
        if( ! empty($params['endCreated'])) {
            $queryBuilder->andWhere('vpo.created <= :endCreated')->setParameter('endCreated', $params['endCreated']);
        }
        return $queryBuilder;
    }
}



```